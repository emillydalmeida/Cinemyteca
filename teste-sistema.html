<!DOCTYPE html>
<html>
<head>
    <title>Teste Sistema Cinemyteca</title>
    <!-- PouchDB CDN -->
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
</head>
<body>
    <h1>Teste Sistema Cinemyteca</h1>
    <div id="status"></div>
    <div id="resultados"></div>
    
    <script type="module">
        const status = document.getElementById('status');
        const resultados = document.getElementById('resultados');
        
        status.innerHTML = 'Iniciando teste...';
        
        class TestePouchDB {
            constructor() {
                this.inicializado = false;
                this.bancoLocal = null;
            }
            
            async inicializar() {
                try {
                    let tentativas = 0;
                    while (!window.PouchDB && tentativas < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        tentativas++;
                    }
                    
                    if (!window.PouchDB) {
                        throw new Error('PouchDB não carregou');
                    }
                    
                    this.bancoLocal = new window.PouchDB('teste-cinemyteca-sistema');
                    this.inicializado = true;
                    
                    status.innerHTML += '<br>✅ Sistema inicializado!';
                    
                    await this.adicionarFilme('acao', {
                        id: 12345,
                        title: 'Filme Teste',
                        poster_path: '/teste.jpg'
                    });
                    
                    const filmes = await this.obterFilmesPorGenero('acao');
                    status.innerHTML += '<br>✅ Teste completo! Filmes encontrados: ' + filmes.length;
                    
                    resultados.innerHTML = '<h3>Filmes encontrados:</h3><pre>' + JSON.stringify(filmes, null, 2) + '</pre>';
                    
                } catch (error) {
                    status.innerHTML += '<br>❌ Erro: ' + error.message;
                    console.error(error);
                }
            }
            
            async adicionarFilme(genero, filme) {
                const documento = {
                    _id: `${genero}_${filme.id}_${Date.now()}`,
                    genero: genero,
                    ...filme,
                    dataAdicao: new Date().toISOString()
                };
                
                return await this.bancoLocal.put(documento);
            }
            
            async obterFilmesPorGenero(genero) {
                const resultado = await this.bancoLocal.allDocs({
                    include_docs: true,
                    startkey: `${genero}_`,
                    endkey: `${genero}_\ufff0`
                });
                
                return resultado.rows
                    .map(row => row.doc)
                    .filter(doc => doc.genero === genero)
                    .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            }
        }
        
        const teste = new TestePouchDB();
        teste.inicializar();
    </script>
</body>
</html>
